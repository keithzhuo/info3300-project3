<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagram 3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .gridlines line {
            stroke: #bbb;
        }

        .gridlines .domain {
            stroke: none;
        }

        #button-bar button {
            /* Blue */
            border: none;
            color: white;
            padding: 12px 17px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            transition-duration: 0.4s;
            cursor: pointer;
        }

        #button-bar button {
            background-color: white;
            color: black;
            border: 2px solid #f6c6bb;
        }

        #button-bar button:hover {
            background-color: #f6c6bb;
            color: white;
        }
    </style>
</head>

<body>
    <p>
    <h2>US Food Production Value from 2003 - 2013</h2>
    </p>
    <p>
    <div id="button-bar" style="margin-left: 65px"></div>
    <svg id="barplot" width="900" height="700"></svg>
    </p>
</body>

<script id="plot3">
    const svg3 = d3.select("svg#barplot");
    const width3 = svg3.attr("width");
    const height3 = svg3.attr("height");
    const margin3 = { top: 150, right: 10, bottom: 200, left: 80 };
    const chartWidth3 = width3 - margin3.left - margin3.right;
    const chartHeight3 = height3 - margin3.top - margin3.bottom;
    let annotations3 = svg3.append("g").attr("id", "annotations");
    let chartArea3 = svg3.append("g").attr("id", "points")
        .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")");


    const requestData3 = async function () {
        const data3 = await d3.csv("US_Food_Production_4.csv");
        console.log(data3)

        data3.forEach((d) => {
            // convert string into integers
            d["production"] = parseFloat(d["production"])
        });

        // x-axis: item
        const itemScale = d3
            .scaleBand()
            .domain(d3.map(data3, (d) => d["item"]))
            .range([0, chartWidth3])
            .padding(0.1);
        const xAxis3 = d3.axisBottom().scale(itemScale);
        const xGridlines3 = d3
            .axisBottom(itemScale)
            .tickSize(-chartHeight3 - 10)
            .tickFormat("");

        annotations3
            .append("g")
            .attr("class", "x axis")
            .attr(
                "transform",
                `translate(${margin3.left},${chartHeight3 + margin3.top + 10})`
            )
            .call(xAxis3)
            .selectAll("text")
            .style("font-size", "12px")
            .style("text-anchor", "end")
            .attr("dx", "-1em")
            .attr("dy", "-.50em")
            .attr("transform", "rotate(-90)");

        // y-axis: production

        const productionExtent = d3.extent(data3, (d) => d["production"]);
        console.log(productionExtent)
        const productionScale = d3
            .scaleLinear()
            .domain(productionExtent)
            .range([chartHeight3, 0]);

        const yAxis3 = d3.axisLeft().scale(productionScale);
        const yGridlines3 = d3
            .axisLeft(productionScale)
            .tickSize(-chartWidth3)
            .tickFormat("");

        annotations3
            .append("g")
            .attr("class", "y axis")
            .attr("transform", `translate(${margin3.left - 10},${margin3.top})`)
            .call(yAxis3)
            .selectAll("text")
            .style("font-size", "12px")

        annotations3
            .append("g")
            .attr("class", "y gridlines")
            .attr("transform", `translate(${margin3.left},${margin3.top})`)
            .call(yGridlines3);

        annotations3
            .append("text")
            .attr("class", "y label")
            .attr("font-size", "14px")
            .attr("text-anchor", "middle")
            .attr("transform", `translate(${margin3.left - 10},${margin3.top + chartHeight3 / 2}) translate(-45, 0) rotate(-90)`)
            .style("font-weight", "bold")
            .text("Amount of food item produced (in 1000 tonnes)");


        var config = {
            avatar_size: 30,
        };

        var defs = svg3.append("svg:defs");

        svg3
            .append("clipPath")
            .attr("id", "clipObj")
            .append("circle")
            .attr("cx", config.avatar_size / 2)
            .attr("cy", config.avatar_size / 2)
            .attr("r", config.avatar_size / 2);


        let data2013 = data3.filter((d) => {
            return d["year"] === "2013";
        });


        data2013.forEach(function (d, i) {
            svg3
                .append("image")
                .attr("xlink:href", d["image"])
                .attr("width", config.avatar_size)
                .attr("height", config.avatar_size)
                .attr(
                    "transform",
                    "translate(" +
                    parseInt(
                        itemScale(d["item"]) + 90 + config.avatar_size / 2
                    ) +
                    "," +
                    parseInt(
                        460
                        // productionScale(d["production"]) +
                        //     config.avatar_size / 2
                    ) +
                    ")"
                )
                .attr("clip-path", "url(#clipObj)");
        });

        function updateBarsByYear(yearKey) {
            const yearData = data3.filter((d) => {
                return d["year"] === yearKey;
            });
            console.log(yearData)

            chartArea3
                .selectAll("rect.bar")
                .data(yearData)
                .join(
                    (enter) =>
                        enter
                            .append("rect")
                            .attr("class", "bar")
                            .attr("fill", "#f6c6bb")
                            .attr("stroke", "black")
                            .attr("stroke-width", 1)
                            .attr("x", (d) => itemScale(d["item"]))
                            .attr("y", (d) => productionScale(d["production"]) - 88)
                            .attr(
                                "height",
                                (d) => productionScale(0) - productionScale(d["production"])
                            )
                            .attr("width", itemScale.bandwidth())
                            .attr("opacity", 0)


                            // image
                            // .append("image")
                            // .attr("xlink:href",(d) => d["Image"])
                            // .attr("width", config.avatar_size)
                            // .attr("height", config.avatar_size)
                            // .attr("x", (d) => itemScale(d["item"]))
                            // .attr("y", (d) => productionScale(d["production"]) - 88)
                            // .attr("clip-path", "url(#clipObj)")


                            .call((enter) => enter.transition().attr("opacity", 1)),
                    (update) =>
                        update.call((update) =>
                            update
                                .transition()
                                .attr("fill", "#f6c6bb")
                                .attr("stroke", "black")
                                .attr("stroke-width", 1)
                                .attr("x", (d) => itemScale(d["item"]))
                                .attr("y", (d) => productionScale(d["production"]) - 88)
                                .attr(
                                    "height",
                                    (d) => productionScale(0) - productionScale(d["production"])
                                )
                                .attr("width", itemScale.bandwidth())
                        ),
                    (exit) =>
                        exit.call((exit) =>
                            exit.transition().attr("opacity", 0).remove()
                        )
                );
        }

        updateBarsByYear("2003");

        let year_domain = new Set();
        data3.forEach((d, i) => {
            year_domain.add(d["year"]);
        });
        year_domain.forEach((d) => {
            d3.select("div#button-bar")
                .append("button")
                .text(d)
                .on("click", function () {
                    updateBarsByYear(d);
                });
        });



    }
    requestData3()


</script>

</html>